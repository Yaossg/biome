# B for Biome

## 生物群系与世界生成

### 生物群系的基本概念

> 如果你不知道什么叫作“生物群系”，我可以告诉你，它是游戏中用于设置何种地表（沙子？还是草？），是下雨还是下雪，长什么树，以及允许何种动物生成的气候区。
>
> ——Jens "Jeb" Bergensten
>
> 曾几何时，混沌初开 方块大陆上的生物们还在试图理解「为啥周围都变方了」 很快他们注意到了这个大陆上的奇妙的气候 特定的区域的气候是常年不变的，但降水却是随机的 相邻的两块区域的气候基本上是相近的，但有时候也会有雪地连着沙漠的情况 这些生物们开始慢慢适应这奇妙的环境，并最终与这奇妙的环境融为一体
>
> ——3TUSK

**生物群系（Biome）** 是描述游戏中不同位置特定属性的享元（Flyweight），它决定了游戏中的自然环境。是的，这个世界无处没有生物群系，这个世界就是由生物群系组成，这个世界的万物包含在生物群系之中。每当加入新的生物群系时，我们都会为之侧目，因为我们知道，这不单单是加入了一个生物群系，更是加入了一个完整的系统。

### 生物群系——生成区块的第一步

> Minecraft会首先获取当前区块下所有的生物群系。
>
> ——ustc-zzzz《答知乎提问：Minecraft 的地形生成算法是什么？》
>
> 在 1.13 以后，不再这样笼统的区分，每个区块都拥有一个状态，每个状态都表示他**已经完成**的某一个任务，并提供下一个任务，以此实现**异步**的区块生成。
>
> <sub>（第一个状态）</sub>基础（base）状态的第一步：生物群系将会被选定
>
> ——Yaossg《浅析1.13世界生成》

在代码层面，生物群系的世界生成的影响也十分深远。正如小标题所言：无论是 1.13 之前还是之后，**生成生物群系都是生成区块的的第一个步骤**。这样的特殊位置也就意味着，要研究世界生成，第一步就是研究生物群系。

## 生物群系的历史回顾

在历史上生物群系发生了许多重大的变迁。下面我们一起走进历史，领略一下过往的经验与教训。

这一部分资料部分整理自 Minecraft 官方维基百科

### Alpha 1.2

生物群系正式加入，主世界有 10 种，下界 1 种，2 种未使用。在这个版本中，**温度**和**降水量**的概念已经有所体现。生物群系的布局根据温度和降水量有关，因此不会出现突兀的温度变化。但是也由于温度和降水量基于噪声算法，导致你会看到犬牙交错的边界，而非平滑的过渡，因此可以认为边缘**宏观平滑，微观破碎**。同时由于这个版本的生物群系生成的普遍较小，导致破碎的根绝更为明显。丘陵、断崖、海洋、沙滩并非作为生物群系出现，而是用算法在生成好的生物群系上进行的二次创作。

我相信这样的破碎可能不会适用于拥有大好风光的主世界，但是如果是一个本来就混沌、荒芜的世界呢？谁能想到，多年之后，这样的生成方式经过一些改进，被用于下界的生物群系生成？

### Beta 1.8 - 1.1

生物群系重写。采用了基于分形（Fractal）的算法，这实际上奠定了长期以来世界生成的方法，**一直沿用至今**。生物群系变得更大，海洋变得更广更深。河流会在生物群系里或者生物群系之间流动并注入海里。河流、丘陵、山地、海洋、沙滩也先后成为生物群系。除了原有的山地（Mountains），还加入了各色的丘陵（Hills），积雪的生物群系又被重新加入。相邻生物群系的温度降雨量的渐变不再体现，常有河流间隔。此外水和植被的颜色有了平滑的过渡。因此可以认为边缘**宏观破碎，微观平滑**。

### 1.2

采用了全新的世界格式 **Anvil**。 与过去不同的是，生物群系信息不再动态计算，而是被储存在了区块文件中：世界一旦生成，这一数值就不会发生改变。这种做法的提高了游戏运行效率，当然这也给外部修改提供了可能。

加入了丛林，预留给树木的四个数据值占满了，大家都以为树木“齐了”，以后还会有更多树吗？

### 1.7

~~迪斯科山！~~Jeb语 平顶山的奇丽景色可能让人第一时间让人关注到这次更新上来。

此次更新加入的生物群系比以前所有版本加入的生物群系加起来还要多，引入了大量的**变种**生物群系。变种是多样化生物群系的好手段。比如在 1.6 时移除的沙漠湖泊，被作为沙漠的一个变种——一种带湖泊的沙漠重新加入。

相邻的生物群系会尽可能的避免突变（从最热到最冷，从最干到最湿），宏观上平滑度有所增加。但也只是尽可能的，所以也比较有限。

移除了过多的海洋、加入了深海。更新前的几乎无尽的海洋不复存在，世界超过半数面积变为了陆地，为新加入的生物群系提供了空间。而深海的加入使海洋的层次更为分明。更新前，玩家分明是生活在一座座被无限大海洋的包围的巨型岛屿上的；更新后，反而成了海洋破碎分布在大陆之间。

重磅回归的热带草原上长着新加入游戏的树木。新树木，Mojang 开了几个新的类，分配了几个新的 id。新沙石，方块好说，台阶却满了，于是又给红砂石台阶分配了新的 id。而在开发平顶山的时候，Mojang 发现之前地表构造器的完全无法复用，索性写了一个完全不同于其他所有生物群系的。

附录里收录了我还原的当年维基百科上挂过的一张表。当时这样的安排可以认为是故意的——显然在 Mojang 看来，获取某个生物群系的变种只不过是 +128 那么简单罢了。新生物群系的命名也极度诡异，诸如M、F、+此类莫名其妙的记号，后来到了扁平化的时候背悉数消灭（但到了最后还是留下了一个+），就连标志性的平顶山也被重命名为“恶地”，让很多人误以为是机翻。

从我前面的描述，你可以感受到的是一副宏伟的画卷在逐步展开，可当你驻足观望，不难发现一片盛景之下潜伏的是无处不在的种种危机。扁平化呼之欲出，重写的腥风血雨正在降临。

### 1.13

> 1.13 Mojang 做出的努力使我眼前一亮，世界生成可以说是最重要的一部分，Mojang 迈出了第一步，希望这不是最后一步。
>
> ——Yaossg《浅析1.13世界生成》

![](<../resources/quotes/3T's sigh.png>)

**扁平化（The Flattening）**，世界生成重写。详见前作《浅析1.13世界生成》

末地的生物生物群系不再全是 ~~sky~~ 扁平化后：the\_end，在末地外岛，不同的地形对应了不同的生物群系，这也就贯彻了生物群系的设计初衷。与主世界的层层叠加不同，末地生物群系的生成比较简单。

水域更新让海洋拥有了温度，根据噪声算法来决定。温度不同——生物群系不同，这贯彻了生物群系的设计初衷。

> 这次Mojang代码的重构采用了全新的设计模式，增加了代码的可扩展性，主要体现在：
>
> * 将世界生成的功能被集中在了**区块生成器和生物群系**两部分上面，而不是离散在方方面面，更便于对代码之间的关系进行分析。
>
> ——Yaossg《浅析1.13世界生成》

生物群系开始把握了世界生成的大量内容。毫无疑问，五彩斑斓的世界正是生物群系所赐。同时我们也应该注意到区块生成器在协调区块与生物群系生成关系方面的作用。

删除了**自定义**世界类型，Mojang 说它一定会在将来的某个版本回归的。

### 1.14

在 1.13 更改的基础上进行了强化。

重写了主世界的生成系统，最终不再是三个层，而是一个。不再使用数组，而是改用套娃的方法。

### 1.15

> 当然，生物群系和高度无关。
>
> ——ustc-zzzz《答知乎提问：Minecraft 的地形生成算法是什么？》

加入了生物群系的在 y 轴上的支持，并在末地和下界更新中被使用。当然了，主世界依然与高度**无关**。采用的新的生物群系缓存方式。

### 20w14∞

愚人节快照...无限的维度、无限的生物群系？！有没有搞错？

看似是愚人节快照，实际上透露了接下来最大的两个方向——自定义维度和生物群系。这项内容的准备工作持续了好几个大版本：当你读到世界生成代码的时候，发现的到处都是的 `Deserializer`，看似莫名其妙，细品实在不简单。

### 1.16

> 我相信这样的破碎可能不会适用于拥有大好风光的主世界，但是如果是一个本来就混沌、荒芜的世界呢？谁能想到，多年之后，这样的生成方式经过一些改进，被用于下界的生物群系生成？
>
> ——Yaossg《再析世界生成：生物群系》生物群系的历史回顾：Alpha 1.2

下界更新！引入了气候参数，用来生成下界的生物群系。等会……这方法，好像在 Alpha 1.2 见过？

自定义维度！当年 Mojang 删除自定义世界类型的时候，曾放言说它一定会回来的。它终于回来了。

### 1.16.2

> 1.16.2，又名 1.17
>
> ——Yaossg 看代码前调侃道

1.16.2 之于 1.16，相当于 1.15 之于 1.14

为什么这么说？因为 1.16.2 的更改，太像一个 major version 了。

* 新的生物
* 资源包版本提升
* 命令、数据包修改
* 自定义生物群系等（也引发了生物群系相关代码大改）

好家伙，估计是 1.15 被骂惨了才让 1.16.2 承受了不该承受的重量。

最值得本文注意的是自定义生物群系了：情理之中，意料之外。本来以为会是 1.16 的内容，结果 1.16 没有。是不是 1.17？也不是。1.16.2 就离谱。

>反了，反了，1.16.2 敢噬主了！
>
>——Yaossg《1.16 赘婿》

“小版本，大更新”说的就是 1.16.2。前面也提到过：它对我的教程的打击是毁灭性的。

### 1.17

> 真的 1.17 来了，更加劲爆！
>
> ——Yaossg，1.17 快照更新前期
> 
> Mojang 删除了 1.17
>
> ——Yaossg，1.17 快照更新后期

_空白_

什么，为什么是空白？这指的是 1.17 的更新内容，不是我的文章。真正的内容还要等 1.18。

### 1.18

TODO

## 生物群系属性

下面这些属性，除个别例外，都可以在自定义生物群系时指定。原版生物群系属性的具体值，详见本文附录。

### 类别

**类别（Category）** 描述的是某一类生物群系所拥有的共同特征。例如，当我说“恶地”的时候，浮现在你脑海里的，绝对不止一个生物群系；那具体有几个恶地、分别叫什么呢？可能就会难倒不少人了。但有一点毫无疑问：反正它跟恶地是一类嘛，这也就是类别的意义。

类别在许多领域都有应用，这里没法一一举例了。而它在生物群系生成中扮演的重要的角色，将在主世界生成中的**相似生物群系**中大显光彩。

### 气候

**气候（Climate）** 是生物群系贯穿始终的最重要的属性，是对生物群系特征的直观感受的概括。粗略分为温度和降水量两个部分。

#### 温度、温度修饰

**温度（Temperature）** 这一属性代表了这个生物群系的**默认温度**。默认温度常常参与的是未知空间上下文的情况的计算。而具体到每个方块上的温度，这里不妨叫**当地温度**。当地温度是默认温度先经过**温度修饰符（TemperatureModifier）** 进行修饰，再根据高度调整得到。

| 温度修饰符 | 生物群系 | 特点 |
| :--- | :--- | :--- |
| none | 其它生物群系 | 直接返回默认温度 |
| frozen | 冻洋、封冻深海 | 根据噪声进行修饰 |

相比而言，高度占主导因素：在 y &gt; 64 后，当地温度会逐渐减小。

#### 降水量和降水类型

**降水量（Downfall）** 代表了这个生物群系的具体湿度。主要用于决定草的颜色，此外降水量大于 0.85 的生物群系的对火的蔓延有抑制作用。而与降水量定量不同，**降水类型（Precipitation）** 更多的是定性。

以上属性造成影响如下表所示：

| 当地温度 | 降水类型 | 影响 |
| :---: | :---: | :---: |
| - | snow | 雪地兔兔~ |
| 大于等于 0.15 | rain | 判定为下雨 |
| 大于等于 0.15 | - | 不会有雪、不会有冰 |
| 小于 0.8 | - | 雪人走过的地方会产生雪片 |
| 大于 1 | - | 雪人受伤 |

此外，温度和降水量还会参与到植物颜色的渲染。

### 深度、规模和地形

**深度（Depth）** 描述的是生物群系的平均海拔。注意这是一个平均值，比如若该数值为 0，虽说理论上是和海平面齐平，但其实相当低洼，因为真正的高度会根据噪声和规模有所起伏。

**规模（Scale）** 描述的是生物群系的高度差值。这个数值越大，地形的高低起伏越大。**放大化（Amplified）** 世界类型、**旧版自定义（Customize）** 世界类型的“山脉狂魔”预设就是扩大了这个数值。放大化在此之外还做了一些特殊处理。

### 气氛

生物群系**特效（Effects）**，主要带来视听体验，营造**气氛（Ambience）**。

* 雾的颜色
* 水的颜色
* 水中雾的颜色
* 天空颜色
* 树叶颜色
* 草颜色
* 草颜色修饰符
* 粒子效果
* 循环音效
* 环境音效
* 额外音效
* 音乐

### 生物生成设置

**生物生成设置（SpawnSettings）**

* 动物生成概率：数值越高，自然生成的动物就越多。寒冷地区这个值偏低。
* 候选生成生物和生成密度（在主世界的体验并不明显，但下界的区别是非常明显的）
* 是否适于玩家出生（在出生点的选择中起到参考的作用）

### 世界生成设置

**世界生成设置（GenerationSettings）** 包含了一些与世界生成有关（主要是地形和特性方面）的内容，包含

* **地表构造器（SurfaceBuilder）**
* **镂空器（Carver）**
* **特性（Feature）**
  * **结构（Structure）**
  * **花（Flower）**
