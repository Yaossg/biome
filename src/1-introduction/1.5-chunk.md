# 区块

> I used to rule the world 我曾统治这世界
>
> **Chunks** would load when I gave the word ~~**区块**会在我的命令下加载~~ 世界听我号令运转
>
> ——CaptainSparklez《Fallen Kingdom》

**区块（Chunk）** 作为一个符号，不得不承认，虽然并不总是如此，但它的的确确成为了世界生成乃至世界的象征。无论是否与世界生成有关，在各种场合，区块这个概念总是被经常提及——好像世界就应该这么分一样。确实，世界生成确实也应该从它讲起。

## 区块生成器

**区块生成器（ChunkGenerator）**，是之前已经提到的，两大非常重要的世界生成提供者之一。

区块生成器分为三种：**噪声**区块生成器（**Noise**ChunkGenerator）、**平坦**区块生成器（**Flat**ChunkGenerator）、**调试**区块生成器（**Debug**ChunkGenerator）。在这里，我们主要介绍噪声区块生成器。另外两个区块生成器参见第三章。

噪声区块生成器主要负责：

- 要塞的选址
- 生物群系的选择
- 应用镂空器
- 特性（包括结构和花）的放置
- 地表和基岩的放置
- 生成原生生物（伴随世界生成产生的生物）

期间与生物群系来源的合作十分紧密。

### 区块状态

这些功能在区块生成的不同状态时被调用，前作已经有过介绍。1.16 中这些状态被细化成了下面 13 个状态：

| 状态                 | 颜色     | 高度图类别 | 范围 | 等级  |
| -------------------- | -------- | ---------- | ---- | ----- |
| empty                | 2213376  | 甲类       | -1   | 44+   |
| structure_starts     | 15884384 | 甲类       | 0    | 36-43 |
| structure_references | 16777215 | 甲类       | 8    |       |
| biomes               | 5526612  | 甲类       | 0    |       |
| noise                | 7169628  | 甲类       | 8    |       |
| surface              | 15658734 | 甲类       | 0    |       |
| carvers              | 13421772 | 甲类       | 0    |       |
| liquid_carvers       | 3159410  | 乙类       | 0    | 35    |
| features             | 13750737 | 乙类       | 8    | 34    |
| light                | 6250897  | 乙类       | 1    |       |
| spawn                | 10066329 | 乙类       | 0    |       |
| heightmaps           | 7497737  | 乙类       | 0    |       |
| full                 | 8434258  | 乙类       | 0    | 33-   |

区块状态仍然分为两类，只有最后一个状态是**存档区级（Level Chunk）** 用于正常的游戏逻辑，而前面的状态都是**原型区块（Proto Chunk）** 专用于世界生成。

高度图类型分为两种，决定了出于当前状态下需要更新的高度图有哪些。可以看出，甲类的均为世界生成专用的高度图，乙类均为正常游戏逻辑使用的高度图。

| 高度图类别 | 高度图                                                       |
| ---------- | ------------------------------------------------------------ |
| 甲类       | OCEAN_FLOOR_WG, WORLD_SURFACE_WG                             |
| 乙类       | OCEAN_FLOOR, WORLD_SURFACE, MOTION_BLOCKING, MOTION_BLOCKING_NO_LEAVES |

### 区块加载与世界生成

上表中的范围（Range）决定的是，某区块进入该状态时，需要加载的周围区块的曼哈顿半径 `r`（该半径下构成的正方形区域边长是 `2 * r + 1`）。-1 无意义。

那么所加载的区块至少需要到那个状态呢？这与区块的等级（Level）有关。我们可以从世界生成加载界面中的图案中得到一些启示。在世界生成加载界面中，每一个生物群系状态对应一种颜色。图片正中心像素的 level = 22，向外每延伸一格，level 加一。颜色和等级对应的区块状态见上表。

![](../resources/loading.png)

（图中的橙色青色为助于识别的辅助线、辅助点和长度标记，实际界面中并不存在）

触发区块 level 改变的不仅仅只有创建世界。实际上，Mojang 引入了**票（Ticket）** 的概念来管理区块加载。



按Range算，最大.... 按Level算，却是....那是因为结构....

// TODO 我已经完全忘记这里要说什么了，要不直接 redirect 海螺摆大烂得了

欲知更多相关内容，可以转阅海螺的文章（链接见附录）

## 区段

**区段（Section）** 是区块沿 y 轴切割得到的 16 等分之一。区段是区块文件中存储方块状态、亮度的最小单位。

**调色盘（Palette）**是方块状态储存中用到的一种压缩方式。如何理解调色盘呢，我们可以从字面意思来类比说明。

对于一幅不透明的像素画，我们当然可以选择用一个二维数组来储存每个像素的颜色值。以 RGB 为例，这需要至少 24 bits 才能储存一个像素。对于一幅稍大点的画作，这样的储存方式将会大的惊人（例如一幅 1920 x 1080 的高清图片，至少需要 47 MB 的空间）。

类似的，我们也可以用一个三维数组来存每个位置的方块状态，但是储存一个方块所需要的空间可远远不止 24 bits。移除方块的数字 id 之后，需要使用完整的名字（例如`"minecraft:stone"`）和表示状态的字符串到字符串的哈希表（例如`{"facing": "north", "waterlogged": "false"}`）来表示一个方块状态，这样的话表示一个方块状态所需的内存将非常的大！更别提世界中不可胜数的方块！

如何压缩呢？不难想到一幅画里的不少像素的颜色其实是一样的，既然如此，我们可以设立一个调色盘，用给图片里所有使用的颜色编号，然后在二维数组中使用这个编号来代替这个颜色。储存编号所需要的空间取决于这幅画有多少种颜色，而这几乎肯定是少于 24 bits 的（例如一幅 1920 x 1080 的高清图片，里面用了 60 种颜色，那么储存一个编号就需要 6 bits，加上一个字典，大约需要 12 MB 的空间）。

类似的，在储存方块的时候，我们也可以这么做。用一个调色盘，或者说字典，给所有区段里的方块编号，然后在三维数组中用这个编号来代替这个方块。实际上，换成整数之后，Mojang 采用了一种比三维数组更紧凑的方法来存储编号。因此，虽然压缩图片的效果不算明显，但是对于方块状态的情形就完全不一样了。这样的压缩算法可以高效使所需空间大大减少。

值得注意的是，在调色盘的例子里面，当颜色数量非常大（以至于非常接近 2<sup>24</sup>）的时候，储存编号和储存颜色所需空间相仿，导致调色盘压缩失灵——你甚至额外还存了一个巨大的调色盘。但是对于区段来说，这几乎不会成为问题——调色盘所占用的额外空间，在储存方块所需空间面前几乎可以忽略不计。何况在一个小小的区段里塞下数千个不同的方块状态，这本身就非常困难。

空的区段（即，全是空气的区段）不会被储存，因此你不需要担心每个区块上空那些区段会不会占用很多空间，同时你也能够找到某些服务器会限高的部分原因了。


## 区元

![](<../resources/quotes/SF's Question.png>)

然而，除了区块，其实还有很多有关世界生成的大小分块。Sebrarin 的说法并不严格，因为：**区元（Area）** 是 MC 生成生物群系的最小单位。

### 区元的来龙去脉

在 1.15 之前，每个区块的生物群系被储存在一个大小为 16 x 16 的数组里面，储存了区块内每一个 1 x 1 x 256 的生物群系。

1.15 更新之后，每个区块的生物群系被储存在一个大小为 4 x 4 x 64 的数组里面，数组里的每一个元素，代表的是一个区元里的生物群系，至于每个方块的生物群系，会动态地计算。

尽管加入了高度支持，但目前所有的生物群系来源生成得到的 x 和 z 相同而 y 不同的区元仍然总是包含相同的生物群系；真正高度上的差别是体现在最后打磨后的，方块尺度上的。不过希望还是要有，我们离 3D 生物群系的支持实际上只差一步之遥。在多重噪声生物群系来源代码中，有一个 boolean 值，直接决定是否让 y 参与计算。目前它_永远_为 false，不过我相信一定不会_永远_为 false 的。（补：这一点在 1.17、1.18 中应验）

在接下来的叙述中，本文用`x, z`这样的二元组来表示 x 和 z 相同的 16 个区元的坐标，其他（如方块、区块等）的坐标会另做说明。

------

### 区元命名杂谈

在最初翻译 Area 时，我不假思索的用了“区域”一词。这本来无可厚非，Area 最常见的翻译就是这个。然而当我意识到它与已有的一个概念——**区域（Region）**，撞车的时候，已经有一段时间了。为此，我当时不得不在文章里写到

> **注意：Region（32 x 32 区块）的翻译也是“区域”。本文无特别说明区域均指 Area，请勿混淆。**

后来觉得这样欠妥，决定还是换个名字。作为生物群系生成的最小单位，作为世界生成中用到的最小的方块集合，也就是最小的一个“区”的概念，“元”一字它当之无愧。

-----

不过此名字一出，便遭各路嘲讽——这分明就是“屈原”嘛。是这样的，对此屈原也很恼火。我最喜欢屈原的一句话是

> 路漫漫其修远兮，吾将上下而求索
>
> ——屈原《离骚》

被嘲讽的可不仅是名字：说实话，写这个教程，何尝不是一个“上下求索”的过程呢？

> 举目见日，不见长安
>
> ——晋明帝语，《世说新语》

梦想遥不可及，现实却触手可得，然而有时候现实的残酷反而把人推向梦想那一边。可梦是做不完的，无尽的梦终究会成为无谓的梦。有时候香肠是一位理想主义者，幻想着心中的长安。但有时候又是一位现实主义者，因为永远也到不了长安。香肠正陷于这无尽的矛盾之中。

香肠的梦是什么？_本节内容结束_
